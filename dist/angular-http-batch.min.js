/*
 * angular-http-batcher - v1.0.0 - 2014-07-22
 * https://github.com/jonsamwell/angular-http-batcher
 * Copyright (c) 2014 Jon Samwell;*/
window.ahb={name:"jcs.angular-http-batch"},angular.module(window.ahb.name,[]),angular.module(window.ahb.name).provider("httpBatchConfig",[function(){"use strict";var a=[],b={maxBatchedRequestPerCall:10,minimumBatchSize:2,batchRequestCollectionDelay:100,ignoredVerbs:["head"]};this.setAllowedBatchEndpoint=function(c,d,e){var f=angular.copy(b);void 0!==e&&(angular.forEach(e,function(a,b){f[b]=a}),angular.forEach(f.ignoredVerbs,function(a,b){f.ignoredVerbs[b]=a.toLowerCase()})),f.serviceUrl=c,f.batchEndpointUrl=d,a.push(f)},this.getBatchConfig=function(b){var c,d;for(d=0;d<a.length&&(c=a[d],!(b.indexOf(c.serviceUrl)>-1));d+=1)c=void 0;return c},this.canBatchCall=function(a,b){var c=this.getBatchConfig(a);return void 0!==c&&c.batchEndpointUrl!==a&&-1===c.ignoredVerbs.indexOf(b.toLowerCase())},this.calculateBoundary=function(){return(new Date).getTime().toString()},this.$get=[function(){return this}]}]),angular.module(window.ahb.name).factory("httpBatcher",["$injector","$timeout","httpBatchConfig",function(a,b,c){"use strict";var d={httpVersion:"HTTP/1.1",newline:"\r\n",emptyString:"",singleSpace:" ",forwardSlash:"/",doubleDash:"--",colon:":"},e={},f=function(a,b){this.part=a,this.request=b},g=function(a,c){var d=this;this.config=a,this.sendCallback=c,this.requests=[],this.currentTimeoutToken=b(function(){d.currentTimeoutToken=void 0,d.requests.length<d.config.minimumBatchSize?angular.forEach(this.requests,function(a){a.continueDownNormalPipeline()}):d.send()},a.batchRequestCollectionDelay,!1)},h=function(a,b){return c.canBatchCall(a,b)},i=function(a){var b=c.getBatchConfig(a.url),d=e[b.batchEndpointUrl];void 0===d&&(d=new g(b,function(){delete e[b.batchEndpointUrl]}),e[b.batchEndpointUrl]=d),d.addRequest(a)};return f.prototype=function(){var a=function(a,b){var c=b;return a=a.toLowerCase(),a.indexOf("json")>-1&&(c=angular.fromJson(b)),c},b=function(a){return a=a.trim?a.trim():a.replace(/^\s+|\s+$/g,"")},c=function(){var c,e,f,g,h=this.part.split(d.newline),i={headers:{}},j=!1;for(e=0;e<h.length;e+=1)if(c=h[e],c!==d.emptyString){if(void 0===i.contentType&&-1!==c.indexOf("-Type")&&-1===c.indexOf("; msgtype=response"))i.contentType=c.split(d.forwardSlash)[1];else if(void 0!==i.contentType&&j===!1)g=c.split(d.colon),i.headers[g[0]]=b(g[1]);else if(void 0===i.statusCode&&-1!==c.indexOf(d.httpVersion))f=c.split(d.singleSpace),i.statusCode=parseInt(f[1],10),i.statusText=f.slice(2).join(d.singleSpace);else if(void 0===i.data&&j){i.data=a(i.contentType,c);break}}else j=void 0!==i.contentType;i.headers["Content-Type"]=i.contentType,this.request.callback(i.statusCode,i.data,i.headers,i.statusText)};return{process:c}}(),g.prototype=function(){var e=function(a,b){var e,f,g,h,j=c.calculateBoundary(),k={method:"POST",url:b.batchEndpointUrl,cache:!1,headers:{"Content-Type":"multipart/mixed; boundary="+j}},l=[];for(f=0;f<a.length;f+=1){g=a[f],e=i(g.url),l.push(d.doubleDash+j),l.push("Content-Type: application/http; msgtype=request",d.emptyString),l.push(g.method+" "+e.relativeUrl+" "+d.httpVersion),l.push("Host: "+e.host);for(h in g.headers)l.push(h+": "+g.headers[h]);l.push(d.emptyString),g.data&&l.push(angular.toJson(g.data)),l.push(d.emptyString)}return l.push(d.doubleDash+j+d.doubleDash),k.data=l.join(d.newline),k},g=function(){var b=this;this.sendCallback(),a.get("$http")(e(this.requests,this.config)).then(function(a){var c,e,g,h=j(a.headers()["content-type"]),i=a.data.split(d.doubleDash+h+d.newline),k=0;for(c=0;c<i.length;c+=1)e=i[c],e!==d.emptyString&&(g=new f(e,b.requests[k]),g.process(),k+=1)},function(a){angular.forEach(b.requests,function(b){b.callback(a.statusCode,a.data,a.headers,a.statusText)})})},h=function(a){return this.requests.push(a),this.requests.length>this.config.maxBatchedRequestPerCall&&(b.cancel(this.currentTimeoutToken),this.currentTimeoutToken=void 0,this.send()),!0},i=function(a){var b=a.indexOf("://")+3,c=a.slice(b).split(d.forwardSlash);return{protocol:a.substring(0,b),host:c[0],relativeUrl:function(){return delete c[0],c.join(d.forwardSlash)}()}},j=function(a){var b="boundary=",c=a.indexOf(b),e=a.substring(c+b.length);return e=e.replace(/"/g,d.emptyString)};return{addRequest:h,send:g}}(),{canBatchRequest:h,batchRequest:i}}]),angular.module(window.ahb.name).config(["$provide",function(a){"use strict";a.decorator("$httpBackend",["$delegate","httpBatcher",function(a,b){var c=function(c,d,e,f,g,h,i,j){var k=this,l=arguments;return b.canBatchRequest(d,c)?void b.batchRequest({method:c,url:d,data:e,callback:f,headers:g,timeout:h,withCredentials:i,responseType:j,continueDownNormalPipeline:function(){a.apply(k,l)}}):a.apply(this,arguments)};return angular.mock&&angular.forEach(a,function(a,b){c[b]=a}),c}])}]);