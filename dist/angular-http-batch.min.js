/*
 * angular-http-batcher - v1.0.0 - 2014-07-21
 * https://github.com/jonsamwell/angular-http-batcher
 * Copyright (c) 2014 Jon Samwell;*/
window.ahb={name:"jcs.angular-http-batch"},angular.module(window.ahb.name,[]),angular.module(window.ahb.name).provider("httpBatchConfig",[function(){"use strict";var a=[],b={maxBatchedRequestPerCall:10,minimumBatchSize:2,batchRequestCollectionDelay:100,ignoredVerbs:["head"]};this.setAllowedBatchEndpoint=function(c,d,e){var f=angular.copy(b);void 0!==e&&(angular.forEach(e,function(a,b){f[b]=a}),angular.forEach(f.ignoredVerbs,function(a,b){f.ignoredVerbs[b]=a.toLowerCase()})),f.serviceUrl=c,f.batchEndpointUrl=d,a.push(f)},this.getBatchConfig=function(b){var c,d;for(d=0;d<a.length&&(c=a[d],!(b.indexOf(c.serviceUrl)>-1));d+=1)c=void 0;return c},this.canBatchCall=function(a,b){var c=this.getBatchConfig(a);return void 0!==c&&c.batchEndpointUrl!==a&&-1===c.ignoredVerbs.indexOf(b.toLowerCase())},this.calculateBoundary=function(){return(new Date).getTime().toString()},this.$get=[function(){return this}]}]),angular.module(window.ahb.name).factory("httpBatcher",["$injector","$timeout","httpBatchConfig",function(a,b,c){"use strict";var d={httpVersion:"HTTP/1.1",newline:"\r\n",emptyString:"",singleSpace:" ",forwardSlash:"/",doubleDash:"--",colon:":"},e={},f=function(a,b){this.part=a,this.request=b},g=function(a,c){var d=this;this.config=a,this.sendCallback=c,this.requests=[],b(function(){d.send()},a.batchRequestCollectionDelay,!1)},h=function(a,b){return c.canBatchCall(a,b)},i=function(a){var b=c.getBatchConfig(a.url),d=e[b.batchEndpointUrl];void 0===d&&(d=new g(b,function(){delete e[b.batchEndpointUrl]}),e[b.batchEndpointUrl]=d),d.addRequest(a)};return f.prototype=function(){var a=function(){var a,b,c,e,f=this.part.split(d.newline),g={headers:{}},h=!1;for(b=0;b<f.length;b+=1)if(a=f[b],a!==d.emptyString){if(void 0===g.contentType&&-1!==a.indexOf("-Type")&&-1===a.indexOf("; msgtype=response"))g.contentType=a.split(d.forwardSlash)[1];else if(void 0!==g.contentType&&h===!1)e=a.split(d.colon),g.headers[e[0]]=e[1];else if(void 0===g.statusCode&&-1!==a.indexOf(d.httpVersion))c=a.split(d.singleSpace),g.statusCode=c[1],g.statusText=c.slice(2).join(d.singleSpace);else if(void 0===g.data&&h){g.data=a;break}}else h=void 0!==g.contentType;g.headers["Content-Type"]=g.contentType,this.request.callback(g.statusCode,g.data,g.headers,g.statusText)};return{process:a}}(),g.prototype=function(){var b=function(a,b){var e,f,g,i,j=c.calculateBoundary(),k={method:"POST",url:b.batchEndpointUrl,cache:!1,headers:{"Content-Type":"multipart/mixed; boundary="+j}},l=[];for(f=0;f<a.length;f+=1){g=a[f],e=h(g.url),l.push(d.doubleDash+j),l.push("Content-Type: application/http; msgtype=request",d.emptyString),l.push(g.method+" "+e.relativeUrl+" "+d.httpVersion),l.push("Host: "+e.host);for(i in g.headers)l.push(i+": "+g.headers[i]);l.push(d.emptyString),g.data&&l.push(angular.toJson(g.data)),l.push(d.emptyString)}return l.push(d.doubleDash+j+d.doubleDash),k.data=l.join(d.newline),k},e=function(){var c=this;this.sendCallback(),a.get("$http")(b(this.requests,this.config)).then(function(a){var b,e,g,h=i(a.headers()["content-type"]),j=a.data.split(d.doubleDash+h+d.newline),k=0;for(b=0;b<j.length;b+=1)e=j[b],e!==d.emptyString&&(g=new f(e,c.requests[k]),g.process(),k+=1)},function(){})},g=function(a){return this.requests.push(a),!0},h=function(a){var b=a.indexOf("://")+3,c=a.slice(b).split(d.forwardSlash);return{protocol:a.substring(0,b),host:c[0],relativeUrl:function(){return delete c[0],c.join(d.forwardSlash)}()}},i=function(a){var b="boundary=",c=a.indexOf(b),e=a.substring(c+b.length);return e=e.replace(/"/g,d.emptyString)};return{addRequest:g,send:e}}(),{canBatchRequest:h,batchRequest:i}}]),angular.module(window.ahb.name).config(["$provide",function(a){"use strict";a.decorator("$httpBackend",["$delegate","httpBatcher",function(a,b){var c=function(c,d,e,f,g,h,i,j){return b.canBatchRequest(d,c)?void b.batchRequest({method:c,url:d,data:e,callback:f,headers:g,timeout:h,withCredentials:i,responseType:j}):a.apply(this,arguments)};return angular.mock&&angular.forEach(a,function(a,b){c[b]=a}),c}])}]);