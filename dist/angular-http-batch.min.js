/*
 * angular-http-batcher - v1.3.0 - 2014-11-18
 * https://github.com/jonsamwell/angular-http-batcher
 * Copyright (c) 2014 Jon Samwell;*/
!function(a,b){"use strict";a.ahb={name:"jcs.angular-http-batch"},b.module(a.ahb.name,[]),b.module(a.ahb.name).provider("httpBatchConfig",[function(){var a=[],c={maxBatchedRequestPerCall:10,minimumBatchSize:2,batchRequestCollectionDelay:100,ignoredVerbs:["head"]};this.setAllowedBatchEndpoint=function(d,e,f){var g=b.copy(c);void 0!==f&&(b.forEach(f,function(a,b){g[b]=a}),b.forEach(g.ignoredVerbs,function(a,b){g.ignoredVerbs[b]=a.toLowerCase()})),g.serviceUrl=d,g.batchEndpointUrl=e,a.push(g)},this.getBatchConfig=function(b){var c,d;for(d=0;d<a.length&&(c=a[d],!(b.indexOf(c.serviceUrl)>-1));d+=1)c=void 0;return c},this.canBatchCall=function(a,b){var c=this.getBatchConfig(a);return void 0!==c&&c.batchEndpointUrl!==a&&-1===c.ignoredVerbs.indexOf(b.toLowerCase())},this.calculateBoundary=function(){return(new Date).getTime().toString()},this.$get=[function(){return this}]}]),b.module(a.ahb.name).factory("httpBatcher",["$injector","$window","$timeout","httpBatchConfig",function(a,c,d,e){var f={httpVersion:"HTTP/1.1",newline:"\r\n",emptyString:"",singleSpace:" ",forwardSlash:"/",doubleDash:"--",colon:":"},g={},h=function(a,b){this.part=a,this.request=b},i=function(a,c){var e=this;this.config=a,this.sendCallback=c,this.requests=[],this.currentTimeoutToken=d(function(){e.currentTimeoutToken=void 0,e.requests.length<e.config.minimumBatchSize?(e.sendCallback(),b.forEach(e.requests,function(a){a.continueDownNormalPipeline()})):e.send()},a.batchRequestCollectionDelay,!1)},j=function(a,b){return e.canBatchCall(a,b)},k=function(a){var b=e.getBatchConfig(a.url),c=g[b.batchEndpointUrl];void 0===c&&(c=new i(b,function(){delete g[b.batchEndpointUrl]}),g[b.batchEndpointUrl]=c),c.addRequest(a)};return h.prototype=function(){var a=function(a,c){var d=c;return a=a.toLowerCase(),a.indexOf("json")>-1&&(d=b.fromJson(c)),d},c=function(a){return a=a.trim?a.trim():a.replace(/^\s+|\s+$/g,"")},d=function(a){var b,c="";for(b in a)c+=b+": "+a[b]+"\n";return c},e=function(){var b,e,g,h,i=this.part.split(f.newline),j={headers:{}},k=!1;for(e=0;e<i.length;e+=1)if(b=i[e],b!==f.emptyString){if(void 0===j.contentType&&-1!==b.indexOf("-Type")&&-1===b.indexOf("; msgtype=response"))j.contentType=b.split(f.forwardSlash)[1];else if(void 0!==j.contentType&&k===!1)h=b.split(f.colon),j.headers[h[0]]=c(h[1]);else if(void 0===j.statusCode&&-1!==b.indexOf(f.httpVersion))g=b.split(f.singleSpace),j.statusCode=parseInt(g[1],10),j.statusText=g.slice(2).join(f.singleSpace);else if(void 0===j.data&&k){j.data=a(j.contentType,b);break}}else k=void 0!==j.contentType;j.headers["Content-Type"]=j.contentType,j.headerString=d(j.headers),this.request.callback(j.statusCode,j.data,j.headerString,j.statusText)};return{process:e}}(),i.prototype=function(){var g=function(a,c){var d,g,h,i,j=e.calculateBoundary(),l={method:"POST",url:c.batchEndpointUrl,cache:!1,headers:{"Content-Type":"multipart/mixed; boundary="+j}},m=[];for(g=0;g<a.length;g+=1){h=a[g],d=k(h.url),m.push(f.doubleDash+j),m.push("Content-Type: application/http; msgtype=request",f.emptyString),m.push(h.method+" "+d.relativeUrl+" "+f.httpVersion),m.push("Host: "+d.host);for(i in h.headers)m.push(i+": "+h.headers[i]);m.push(f.emptyString),h.data&&m.push(b.toJson(h.data)),m.push(f.emptyString)}return m.push(f.doubleDash+j+f.doubleDash),l.data=m.join(f.newline),l},i=function(){var c=this;this.sendCallback(),a.get("$http")(g(this.requests,this.config)).then(function(a){var b,d,e,g=l(a.headers()["content-type"]),i=a.data.split(f.doubleDash+g+f.newline),j=0;for(b=0;b<i.length;b+=1)d=i[b],d!==f.emptyString&&(e=new h(d,c.requests[j]),e.process(),j+=1)},function(a){b.forEach(c.requests,function(b){b.callback(a.statusCode,a.data,a.headers,a.statusText)})})},j=function(a){return this.requests.push(a),this.requests.length>this.config.maxBatchedRequestPerCall&&(d.cancel(this.currentTimeoutToken),this.currentTimeoutToken=void 0,this.send()),!0},k=function(a){var b,d,e,g,h;return a.indexOf("://")>-1?(g=a.indexOf("://")+3,h=a.slice(g).split(f.forwardSlash),b=a.substring(0,g),d=h[0],e=function(){return delete h[0],h.join(f.forwardSlash)}()):(e=a,b=c.location.protocol,d=c.location.host),{protocol:b,host:d,relativeUrl:e}},l=function(a){var b="boundary=",c=a.indexOf(b),d=a.substring(c+b.length);return d=d.replace(/"/g,f.emptyString)};return{addRequest:j,send:i}}(),{canBatchRequest:j,batchRequest:k}}]),b.module(a.ahb.name).config(["$provide",function(a){a.decorator("$httpBackend",["$delegate","httpBatcher",function(a,c){var d=function(b,d,e,f,g,h,i,j){var k=this,l=arguments;return c.canBatchRequest(d,b)?void c.batchRequest({method:b,url:d,data:e,callback:f,headers:g,timeout:h,withCredentials:i,responseType:j,continueDownNormalPipeline:function(){a.apply(k,l)}}):a.apply(this,arguments)};return b.mock&&b.forEach(a,function(a,b){d[b]=a}),d}])}])}(window,angular);