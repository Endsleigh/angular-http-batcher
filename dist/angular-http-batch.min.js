/*
 * angular-http-batcher - v1.0.0 - 2014-08-03
 * https://github.com/jonsamwell/angular-http-batcher
 * Copyright (c) 2014 Jon Samwell;*/
!function(a,b){"use strict";a.ahb={name:"jcs.angular-http-batch"},b.module(a.ahb.name,[]),b.module(a.ahb.name).provider("httpBatchConfig",[function(){var a=[],c={maxBatchedRequestPerCall:10,minimumBatchSize:2,batchRequestCollectionDelay:100,ignoredVerbs:["head"]};this.setAllowedBatchEndpoint=function(d,e,f){var g=b.copy(c);void 0!==f&&(b.forEach(f,function(a,b){g[b]=a}),b.forEach(g.ignoredVerbs,function(a,b){g.ignoredVerbs[b]=a.toLowerCase()})),g.serviceUrl=d,g.batchEndpointUrl=e,a.push(g)},this.getBatchConfig=function(b){var c,d;for(d=0;d<a.length&&(c=a[d],!(b.indexOf(c.serviceUrl)>-1));d+=1)c=void 0;return c},this.canBatchCall=function(a,b){var c=this.getBatchConfig(a);return void 0!==c&&c.batchEndpointUrl!==a&&-1===c.ignoredVerbs.indexOf(b.toLowerCase())},this.calculateBoundary=function(){return(new Date).getTime().toString()},this.$get=[function(){return this}]}]),b.module(a.ahb.name).factory("httpBatcher",["$injector","$timeout","httpBatchConfig",function(a,c,d){var e={httpVersion:"HTTP/1.1",newline:"\r\n",emptyString:"",singleSpace:" ",forwardSlash:"/",doubleDash:"--",colon:":"},f={},g=function(a,b){this.part=a,this.request=b},h=function(a,d){var e=this;this.config=a,this.sendCallback=d,this.requests=[],this.currentTimeoutToken=c(function(){e.currentTimeoutToken=void 0,e.requests.length<e.config.minimumBatchSize?b.forEach(e.requests,function(a){a.continueDownNormalPipeline()}):e.send()},a.batchRequestCollectionDelay,!1)},i=function(a,b){return d.canBatchCall(a,b)},j=function(a){var b=d.getBatchConfig(a.url),c=f[b.batchEndpointUrl];void 0===c&&(c=new h(b,function(){delete f[b.batchEndpointUrl]}),f[b.batchEndpointUrl]=c),c.addRequest(a)};return g.prototype=function(){var a=function(a,c){var d=c;return a=a.toLowerCase(),a.indexOf("json")>-1&&(d=b.fromJson(c)),d},c=function(a){return a=a.trim?a.trim():a.replace(/^\s+|\s+$/g,"")},d=function(){var b,d,f,g,h=this.part.split(e.newline),i={headers:{}},j=!1;for(d=0;d<h.length;d+=1)if(b=h[d],b!==e.emptyString){if(void 0===i.contentType&&-1!==b.indexOf("-Type")&&-1===b.indexOf("; msgtype=response"))i.contentType=b.split(e.forwardSlash)[1];else if(void 0!==i.contentType&&j===!1)g=b.split(e.colon),i.headers[g[0]]=c(g[1]);else if(void 0===i.statusCode&&-1!==b.indexOf(e.httpVersion))f=b.split(e.singleSpace),i.statusCode=parseInt(f[1],10),i.statusText=f.slice(2).join(e.singleSpace);else if(void 0===i.data&&j){i.data=a(i.contentType,b);break}}else j=void 0!==i.contentType;i.headers["Content-Type"]=i.contentType,this.request.callback(i.statusCode,i.data,i.headers,i.statusText)};return{process:d}}(),h.prototype=function(){var f=function(a,c){var f,g,h,i,k=d.calculateBoundary(),l={method:"POST",url:c.batchEndpointUrl,cache:!1,headers:{"Content-Type":"multipart/mixed; boundary="+k}},m=[];for(g=0;g<a.length;g+=1){h=a[g],f=j(h.url),m.push(e.doubleDash+k),m.push("Content-Type: application/http; msgtype=request",e.emptyString),m.push(h.method+" "+f.relativeUrl+" "+e.httpVersion),m.push("Host: "+f.host);for(i in h.headers)m.push(i+": "+h.headers[i]);m.push(e.emptyString),h.data&&m.push(b.toJson(h.data)),m.push(e.emptyString)}return m.push(e.doubleDash+k+e.doubleDash),l.data=m.join(e.newline),l},h=function(){var c=this;this.sendCallback(),a.get("$http")(f(this.requests,this.config)).then(function(a){var b,d,f,h=k(a.headers()["content-type"]),i=a.data.split(e.doubleDash+h+e.newline),j=0;for(b=0;b<i.length;b+=1)d=i[b],d!==e.emptyString&&(f=new g(d,c.requests[j]),f.process(),j+=1)},function(a){b.forEach(c.requests,function(b){b.callback(a.statusCode,a.data,a.headers,a.statusText)})})},i=function(a){return this.requests.push(a),this.requests.length>this.config.maxBatchedRequestPerCall&&(c.cancel(this.currentTimeoutToken),this.currentTimeoutToken=void 0,this.send()),!0},j=function(a){var b=a.indexOf("://")+3,c=a.slice(b).split(e.forwardSlash);return{protocol:a.substring(0,b),host:c[0],relativeUrl:function(){return delete c[0],c.join(e.forwardSlash)}()}},k=function(a){var b="boundary=",c=a.indexOf(b),d=a.substring(c+b.length);return d=d.replace(/"/g,e.emptyString)};return{addRequest:i,send:h}}(),{canBatchRequest:i,batchRequest:j}}]),b.module(a.ahb.name).config(["$provide",function(a){a.decorator("$httpBackend",["$delegate","httpBatcher",function(a,c){var d=function(b,d,e,f,g,h,i,j){var k=this,l=arguments;return c.canBatchRequest(d,b)?void c.batchRequest({method:b,url:d,data:e,callback:f,headers:g,timeout:h,withCredentials:i,responseType:j,continueDownNormalPipeline:function(){a.apply(k,l)}}):a.apply(this,arguments)};return b.mock&&b.forEach(a,function(a,b){d[b]=a}),d}])}])}(window,angular);