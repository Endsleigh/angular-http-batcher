/*
 * angular-http-batcher - v1.0.0 - 2014-07-20
 * https://github.com/jonsamwell/angular-http-batcher
 * Copyright (c) 2014 Jon Samwell;*/
window.ahb={name:"jcs.angular-http-batch"},angular.module(window.ahb.name,[]),angular.module(window.ahb.name).provider("httpBatchConfig",[function(){"use strict";var a=[],b={maxBatchedRequestPerCall:10,minimumBatchSize:2,batchRequestCollectionDelay:100,ignoredVerbs:["head"]};this.setAllowedBatchEndpoint=function(c,d,e){var f=angular.copy(b);void 0!==e&&(angular.forEach(e,function(a,b){f[b]=a}),angular.forEach(f.ignoredVerbs,function(a,b){f.ignoredVerbs[b]=a.toLowerCase()})),f.serviceUrl=c,f.batchEndpointUrl=d,a.push(f)},this.getBatchConfig=function(b){var c,d;for(d=0;d<a.length&&(c=a[d],!(b.indexOf(c.serviceUrl)>-1));d+=1)c=void 0;return c},this.canBatchCall=function(a,b){var c=this.getBatchConfig(a);return void 0!==c&&c.batchEndpointUrl!==a&&-1===c.ignoredVerbs.indexOf(b.toLowerCase())},this.calculateBoundary=function(){return(new Date).getTime().toString()},this.$get=[function(){return this}]}]),angular.module(window.ahb.name).factory("httpBatcher",["$injector","$timeout","httpBatchConfig",function(a,b,c){"use strict";var d={httpVersion:"HTTP/1.1",newline:"\r\n",emptyString:"",singleSpace:" ",forwardSlash:"/",doubleDash:"--",colon:":"},e=function(a,b){this.part=a,this.request=b},f=function(a,c){var d=this;this.config=a,this.sendCallback=c,this.requests=[],b(function(){d.send()},a.batchRequestCollectionDelay,!1)};e.prototype=function(){var a=function(){var a,b,c=this.part.split(d.newline),e={headers:{}},f=!1;for(b=0;b<c.length;b+=1)if(a=c[b],a!==d.emptyString){if(void 0===e.contentType&&-1!==a.indexOf("-Type")&&-1===a.indexOf("; msgtype=response"))e.contentType=a.split(d.forwardSlash)[1];else if(void 0!==e.contentType&&f===!1){var g=a.split(d.colon);e.headers[g[0]]=g[1]}else if(void 0===e.statusCode&&-1!==a.indexOf(d.httpVersion)){var h=a.split(d.singleSpace);e.statusCode=h[1],e.statusText=h.slice(2).join(d.singleSpace)}else if(void 0===e.data&&f){e.data=a;break}}else f=void 0!==e.contentType;e.headers["Content-Type"]=e.contentType,this.request.callback(e.statusCode,e.data,e.headers,e.statusText)};return{process:a}}(),f.prototype=function(){var b=function(a,b){var e,f,g,i,j=c.calculateBoundary(),k={method:"POST",url:b.batchEndpointUrl,cache:!1,headers:{"Content-Type":"multipart/mixed; boundary="+j}},l=[];for(f=0;f<a.length;f+=1){g=a[f],e=h(g.url),l.push(d.doubleDash+j),l.push("Content-Type: application/http; msgtype=request",d.emptyString),l.push(g.method+" "+e.relativeUrl+" "+d.httpVersion),l.push("Host: "+e.host);for(i in g.headers)l.push(i+": "+g.headers[i]);l.push(d.emptyString),g.data&&l.push(angular.toJson(g.data)),l.push(d.emptyString)}return l.push(d.doubleDash+j+d.doubleDash),k.data=l.join(d.newline),k},f=function(){var c=this;this.sendCallback(),a.get("$http")(b(this.requests,this.config)).then(function(a){var b,f,g,h=i(a.headers()["content-type"]),j=a.data.split(d.doubleDash+h+d.newline),k=0;for(b=0;b<j.length;b+=1)f=j[b],f!==d.emptyString&&(g=new e(f,c.requests[k]),g.process(),k+=1)},function(){})},g=function(a){return this.requests.push(a),!0},h=function(a){var b=a.indexOf("://")+3,c=a.slice(b).split(d.forwardSlash);return{protocol:a.substring(0,b),host:c[0],relativeUrl:function(){return delete c[0],c.join(d.forwardSlash)}()}},i=function(a){var b="boundary=",c=a.indexOf(b),e=a.substring(c+b.length);return e=e.replace(/"/g,d.emptyString)};return{addRequest:g,send:f}}();var g={},h=function(a,b){return c.canBatchCall(a,b)},i=function(a){var b=c.getBatchConfig(a.url),d=g[b.batchEndpointUrl];void 0===d&&(d=new f(b,function(){delete g[b.batchEndpointUrl]}),g[b.batchEndpointUrl]=d),d.addRequest(a)};return{canBatchRequest:h,batchRequest:i}}]),angular.module(window.ahb.name).config(["$provide",function(a){"use strict";a.decorator("$httpBackend",["$delegate","httpBatcher",function(a,b){return function(c,d,e,f,g,h,i,j){return b.canBatchRequest(d,c)?void b.batchRequest({method:c,url:d,data:e,callback:f,headers:g,timeout:h,withCredentials:i,responseType:j}):a.apply(this,arguments)}}])}]);